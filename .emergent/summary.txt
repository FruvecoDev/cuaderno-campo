<analysis>**original_problem_statement:**
Desarrollar una aplicación de campo para el sector de agricultura que permita realizar un Cuaderno de Campo completo; Contratos, Parcelas, Mapas, Fincas, Visitas, Tareas, Cosechas, Tratamientos, Irrigaciones, Recetas y Albaranes… Dashboard, Generación de informes en pdf y Excel, panel de configuración de usuarios y permisos de aplicación. Acceso a la aplicación con usuario y login. Aplicar integraciones con IA.

Un contrato siempre estará asignado a una parcela y un cultivo. Sobre una parcela que tiene asociado un cultivo se pueden realizar múltiples visitas y tratamientos. Cuando finaliza un cultivo de una parcela se podrá generar el cuaderno de campo descargable en pdf con todo el seguimiento realizado de esa parcela y cultivo.

Cada sección puede ser configurable pudiendo habilitar o deshabilitar secciones por usuario. También los campos de cada sección son configurables.

**PRODUCT REQUIREMENTS:**
-   **Modules:** Contracts, Parcels, Maps, Farms, Visits, Tasks, Harvests, Treatments, Irrigations, Recipes, Delivery Notes, Suppliers, Crops, Machinery, Evaluation Sheets, Applicator Technicians, Farm Articles, Purchase/Sale Agents, **Clients**.
-   **Core Features:**
    -   Dashboard with KPIs and upcoming events.
    -   PDF and Excel report generation.
    -   User and permissions management panel (RBAC), including menu visibility per user.
    -   Admin can manage user details (name, email, password).
    -   User authentication (login).
    -   Advanced search filters and configurable columns/fields per module.
    -   Dynamically generated questionnaires within modules.
    -   Collapsible side menu.
    -   Multi-language support.
    -   Custom translation dictionary.
    -   Smart Field Notebook generation (PDF with AI summary), including images.
    -   Drag-and-drop file uploads.
-   **AI Integrations:**
    -   AI-powered summary reports for contracts.
    -   AI Assistant for treatment suggestions and harvest yield predictions.

**User's preferred language**: Español

**what currently exists?**
Una aplicación full-stack (FastAPI, React, MongoDB) para la gestión agrícola. Se ha implementado un nuevo módulo de Clientes y se ha modificado la lógica de Contratos y Albaranes para distinguir entre Compra (con Proveedores) y Venta (con Clientes). El formulario de Albaranes ha sido rediseñado para un flujo más intuitivo, preguntando primero el tipo (Compra/Venta) y mostrando los campos correspondientes. Sin embargo, la página de Albaranes sufre un error crítico de carga de datos que impide su uso.

**Last working item**:
-   **Last item agent was working**: Depurando un error persistente ( o variaciones) que ocurre al cargar la página de Albaranes (). El agente intentó múltiples soluciones (refactorización de , eliminación de , uso de ) sin éxito, ya que el usuario sigue reportando el error en el entorno de previsualización.
-   **Status**: BLOCKED
-   **Agent Testing Done**: N (Las pruebas del agente no reproducen el error reportado por el usuario, por lo que no son válidas.)
-   **Which testing method agent to use?**: troubleshoot_agent (Este es un bug recurrente y el agente principal está atascado).
-   **User Testing Done**: N (El usuario confirma que la página sigue rota).

**All Pending/In progress Issue list**:
-   **Issue 1: Error crítico al cargar la página de Albaranes (P0)**
-   **Issue 2: Finalizar implementación de notificaciones por email (P1)**

**Issues Detail**:
-   **Issue 1: Error crítico al cargar la página de Albaranes**
    -   **Attempted fixes**:
        -   Refactorización de todas las llamadas  en  y otros archivos (, , ) para asegurar que el cuerpo de la respuesta (, ) se lea una sola vez.
        -   Reestructuración del  de carga inicial en  para usar  con un flag  y evitar ejecuciones múltiples.
        -   Eliminación de  de  para descartar que el problema fuera el doble renderizado en desarrollo.
        -   Reemplazo de  por  como último recurso.
        -   El mensaje de error ha variado entre , , y , lo que indica que el problema subyacente persiste a pesar de los cambios.
    -   **Next debug checklist**:
        1.  El agente no puede reproducir el error, pero el usuario sí. Esto es un bloqueo crítico. La primera acción debe ser invocar al  para obtener una nueva perspectiva sobre el problema.
        2.  Re-habilitar . Su eliminación es una mala práctica y oculta el problema real, que probablemente es un efecto secundario en un  que no es idempotente.
        3.  En , comentar temporalmente las llamadas a las funciones de carga de datos dentro del  una por una para aislar qué  específico está causando la corrupción de la respuesta.
        4.  Utilizar las herramientas de desarrollador del navegador para inspeccionar la pestaña Network y ver el estado, la respuesta y las cabeceras de la petición que falla.
    -   **Why fix this issue and what will be achieved with the fix?**: La página de Albaranes es inutilizable. Solucionarlo es crucial para la funcionalidad principal de la aplicación.
    -   **Status**: BLOCKED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on other issue**: None
-   **Issue 2: Finalizar implementación de notificaciones por email**
    -   **Attempted fixes**: La estructura básica existe (, ).
    -   **Next debug checklist**:
        1.  Solicitar la  al usuario.
        2.  Añadir la clave al fichero .
        3.  Implementar un planificador en segundo plano (ej: ) para enviar notificaciones.
    -   **Why fix this issue and what will be achieved with the fix?**: Permitirá enviar recordatorios proactivos por email.
    -   **Status**: BLOCKED
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: Necesita la  del usuario.

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   **P1**: Implementar el sistema de aplicación de comisiones a un contrato, cultivo o parcela.
-   **Future Tasks**:
    -   **P2**: Mejorar el mapa interactivo con funciones avanzadas de edición para las parcelas.

**Completed work in this session**
-   **Feature**: Se completó la adición de campos de comisión (, ) al módulo de Contratos.
-   **Feature**: Se creó un nuevo módulo Clientes con CRUD completo y una página de gestión en el frontend.
-   **Feature**: Se implementó una vista de Resumen de Ventas por cliente, con KPIs y contratos asociados.
-   **Feature**: Se refactorizó la lógica de Contratos y Albaranes para manejar la dualidad Proveedor (Compras) vs. Cliente (Ventas).
-   **Feature**: Se rediseñó completamente el formulario de creación de Albaranes para un flujo más intuitivo, donde primero se elige el tipo (Compra/Venta) y el contrato es opcional.
-   **User Support**: Se proporcionaron instrucciones detalladas para ejecutar el proyecto localmente y se aclararon dudas sobre las APIs de OpenAI vs. suscripciones de ChatGPT.
-   **Bugfix (Attempted)**: Múltiples intentos fallidos para resolver el error  en la página de Albaranes.

**Earlier issues found/mentioned but not fixed**
-   None.

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Stack**: FARM (FastAPI, React, MongoDB)
-   **UI**: shadcn/ui, 
-   **State Management**: React Hooks (, , )
-   **Bug**: La aplicación sufre un error persistente relacionado con la lectura del cuerpo de las respuestas  (), probablemente causado por un  no idempotente que  estaba detectando.

**key DB schema**
-   **clientes**:  (New Collection)
-   **contratos**: 
-   **albaranes**: 

**changes in tech stack**
-   None.

**All files of reference**
-   : Archivo principal modificado y donde reside el bug actual.
-   : Nueva página para la gestión de clientes.
-   : Nuevo router para el CRUD de clientes.
-   : Modificado para la lógica de cliente/proveedor.
-   : Modificado para aceptar .
-   : Actualizado con los nuevos campos y colecciones.
-   : Se eliminó  como intento de solución.

**Areas that need refactoring**:
-   ****: Este componente se ha vuelto excesivamente grande y complejo. Maneja la lógica y el estado de albaranes, proveedores, clientes y contratos. Debería descomponerse en componentes más pequeños y manejables.
-   ** de carga de datos**: El  en  es propenso a errores y ha sido la fuente de una depuración extensiva. Necesita ser refactorizado para ser robusto e idempotente, permitiendo que  se vuelva a habilitar.

**key api endpoints**
-    (CRUD para Clientes)
-   
-    (ahora  es opcional y acepta )

**Critical Info for New Agent**
1.  **P0 BLOCKER: FIX ALBARANES PAGE**: Tu prioridad absoluta es resolver el error  (o sus variantes) en la página de Albaranes. El agente anterior no pudo solucionarlo. **NO ASUMAS QUE ESTÁ RESUELTO**. Usa el  inmediatamente.
2.  **REACT STRICT MODE**:  fue eliminado de  como un parche. Esto es una mala práctica. El objetivo es arreglar el  en  para que sea idempotente y luego **re-habilitar **.
3.  **USER'S LOCAL ENVIRONMENT**: El usuario está configurando el proyecto localmente. Prepárate para más preguntas sobre dependencias (, ) y configuración de .

**documents and test reports created in this job**
-    (actualizado)

**Last 10 User Messages and any pending HUMAN messages**
1.   - **Request**: Filter contracts in Delivery Notes form. **Status: COMPLETED**.
2.   - **Bug Report**: User reports the error persists. **Status: PENDING**.
3.   - **Bug Report**: User reports error on page load. **Status: PENDING**.
4.   - **Bug Report**: User reports error again after a fix attempt. **Status: PENDING**.
5.   - **Bug Report**: User confirms error persists after multiple fixes. **Status: PENDING**.
6.   - **Bug Report & Clarification**: User confirms error persists and clarifies business logic. **Status: PENDING**.
7.   - **Bug Report**: User confirms error again. **Status: PENDING**.
8.   - **Bug Report**: User reports a new variation of the same error. **Status: PENDING**.
9.   - **Bug Report**: User reports another variation of the error. **Status: PENDING**.
10.  - **Clarification**: User confirms the error is happening in the Emergent preview environment, not just locally. **Status: PENDING**.

**Project Health Check:**
-   **Broken**: La página de Albaranes () es inutilizable debido a un error crítico de carga de datos.
-   **Mocked**: Sistema de notificaciones por email.

**3rd Party Integrations**
-   **OpenAI GPT-4o**: Uses Emergent LLM Key.
-   **Recharts**: Data visualization.
-   **react-i18next / i18next**: Multi-language support.
-   **WeasyPrint**: PDF generation.
-   **openpyxl**: Excel file generation.
-   **Resend**: For email notifications (parcialmente integrado, bloqueado).
-   **Leaflet.js / OpenStreetMap**: Maps.
-   **react-dropzone**: For drag-and-drop file uploads.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: No
-   **Known regressions**: La página de Albaranes funcionaba y ahora está rota.

**Credentials to test flow:**
-   **Admin**:  / 
-   **Manager**:  / 

**What agent forgot to execute**
-   El agente no utilizó el  a pesar de estar claramente atascado en un bucle de depuración con el error .
-   El agente eliminó  como una solución, en lugar de abordar la causa raíz del problema que  estaba señalando (un efecto no idempotente).</analysis>
